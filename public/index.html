<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人语音通话</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 800px;
            width: 90%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .room-section {
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #5a6fd8;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mute-btn {
            background: #e74c3c;
        }

        .mute-btn:hover {
            background: #c0392b;
        }

        .mute-btn.muted {
            background: #95a5a6;
        }

        .users-section {
            margin-bottom: 20px;
        }

        .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .user-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-width: 200px;
            text-align: center;
        }

        .user-card.speaking {
            border-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
        }

        .user-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .user-status {
            font-size: 12px;
            color: #666;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .error {
            color: #e74c3c;
            background: #fdf2f2;
            border: 1px solid #e74c3c;
        }

        .success {
            color: #27ae60;
            background: #f2fdf5;
            border: 1px solid #27ae60;
        }

        .audio-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #95a5a6;
            margin: 0 auto 10px;
            transition: background 0.3s;
        }

        .audio-indicator.active {
            background: #27ae60;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .call-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .call-status h3 {
            color: #333;
            margin: 0;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .modal-content p {
            margin-bottom: 25px;
            color: #666;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .accept-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .accept-btn:hover {
            background: #229954;
        }

        .reject-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .reject-btn:hover {
            background: #c0392b;
        }

        .user-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .user-card.in-call {
            border-color: #27ae60;
            background: #f8fff9;
        }

        .call-button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .call-button:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎙️ 多人语音通话</h1>
            <p>支持多人实时语音通话</p>
        </div>

        <div class="room-section">
            <div class="input-group">
                <input type="text" id="roomId" placeholder="输入房间号" value="">
                <input type="text" id="userName" placeholder="输入您的昵称" value="">
                <button id="joinBtn">加入房间</button>
            </div>
        </div>

        <div id="callSection" class="hidden">
            <div class="call-status">
                <h3 id="callStatusText">已进入房间，点击用户头像发起通话</h3>
            </div>

            <div class="controls">
                <button id="muteBtn" class="mute-btn">🔇 静音</button>
                <button id="endCallBtn" class="hidden">📞 结束通话</button>
                <button id="leaveBtn">🚪 离开房间</button>
            </div>

            <div class="users-section">
                <h3>房间成员</h3>
                <div id="usersList" class="users-list"></div>
            </div>
        </div>

        <!-- 通话邀请弹窗 -->
        <div id="callInviteModal" class="modal hidden">
            <div class="modal-content">
                <h3>📞 收到通话邀请</h3>
                <p id="inviteMessage"></p>
                <div class="modal-buttons">
                    <button id="acceptCallBtn" class="accept-btn">✅ 接听</button>
                    <button id="rejectCallBtn" class="reject-btn">❌ 拒绝</button>
                </div>
            </div>
        </div>

        <div id="status" class="status">
            请输入房间号和昵称加入通话
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        class VoiceChat {
            constructor() {
                this.socket = null;
                this.localStream = null;
                this.peers = new Map();
                this.roomId = null;
                this.userName = null;
                this.isMuted = false;
                this.inCall = false;
                this.callParticipants = new Set();
                this.currentCaller = null;
                
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.roomIdInput = document.getElementById('roomId');
                this.userNameInput = document.getElementById('userName');
                this.joinBtn = document.getElementById('joinBtn');
                this.muteBtn = document.getElementById('muteBtn');
                this.endCallBtn = document.getElementById('endCallBtn');
                this.leaveBtn = document.getElementById('leaveBtn');
                this.callSection = document.getElementById('callSection');
                this.usersList = document.getElementById('usersList');
                this.status = document.getElementById('status');
                this.callStatusText = document.getElementById('callStatusText');
                this.callInviteModal = document.getElementById('callInviteModal');
                this.inviteMessage = document.getElementById('inviteMessage');
                this.acceptCallBtn = document.getElementById('acceptCallBtn');
                this.rejectCallBtn = document.getElementById('rejectCallBtn');
                
                // 生成随机房间号
                this.roomIdInput.value = Math.random().toString(36).substring(7);
            }

            bindEvents() {
                this.joinBtn.addEventListener('click', () => this.joinRoom());
                this.muteBtn.addEventListener('click', () => this.toggleMute());
                this.endCallBtn.addEventListener('click', () => this.endCall());
                this.leaveBtn.addEventListener('click', () => this.leaveRoom());
                this.acceptCallBtn.addEventListener('click', () => this.acceptCall());
                this.rejectCallBtn.addEventListener('click', () => this.rejectCall());
            }

            updateStatus(message, type = '') {
                this.status.textContent = message;
                this.status.className = 'status ' + type;
            }

            async joinRoom() {
                this.roomId = this.roomIdInput.value.trim();
                this.userName = this.userNameInput.value.trim();

                if (!this.roomId || !this.userName) {
                    this.updateStatus('请输入房间号和昵称', 'error');
                    return;
                }

                try {
                    this.updateStatus('正在获取麦克风权限...', '');
                    
                    // 获取音频流
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });

                    this.updateStatus('正在连接服务器...', '');
                    
                    // 连接Socket.IO
                    this.socket = io();
                    this.bindSocketEvents();
                    
                    // 加入房间
                    this.socket.emit('join-room', this.roomId, this.userName);
                    
                    this.callSection.classList.remove('hidden');
                    this.joinBtn.disabled = true;
                    this.updateStatus(`已加入房间: ${this.roomId}`, 'success');
                    
                } catch (error) {
                    console.error('加入房间失败:', error);
                    this.updateStatus('无法获取麦克风权限，请检查浏览器设置', 'error');
                }
            }

            bindSocketEvents() {
                this.socket.on('user-joined', (userId) => {
                    console.log('用户加入:', userId);
                    this.updateStatus(`${userId} 加入了房间`, 'success');
                    // 不立即创建连接，等待通话邀请
                });

                this.socket.on('user-left', (userId) => {
                    console.log('用户离开:', userId);
                    this.updateStatus(`${userId} 离开了房间`, '');
                    this.removePeer(userId);
                    this.callParticipants.delete(userId);
                    this.updateCallStatus();
                });

                this.socket.on('room-users', (users) => {
                    console.log('房间用户:', users);
                    this.updateUsersList(users);
                });

                // 通话邀请相关事件
                this.socket.on('call-invite', (data) => {
                    console.log('收到通话邀请:', data.caller);
                    this.showCallInvite(data.caller);
                });

                this.socket.on('call-response', (data) => {
                    console.log('通话响应:', data);
                    if (data.accepted) {
                        this.updateStatus(`${data.responder} 接受了通话`, 'success');
                        this.startCall(data.responder);
                    } else {
                        this.updateStatus(`${data.responder} 拒绝了通话`, '');
                    }
                });

                this.socket.on('call-started', (data) => {
                    console.log('通话开始:', data.participants);
                    this.callParticipants = new Set(data.participants);
                    this.inCall = true;
                    this.updateCallStatus();
                });

                this.socket.on('offer', async (data) => {
                    console.log('收到offer:', data.caller);
                    await this.handleOffer(data);
                });

                this.socket.on('answer', async (data) => {
                    console.log('收到answer:', data.answerer);
                    await this.handleAnswer(data);
                });

                this.socket.on('ice-candidate', async (data) => {
                    console.log('收到ICE candidate:', data.sender);
                    await this.handleIceCandidate(data);
                });
            }

            async createPeerConnection(userId, isInitiator) {
                const peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                // 添加本地音频流
                this.localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, this.localStream);
                });

                // 处理远程音频流
                peerConnection.ontrack = (event) => {
                    console.log('收到远程音频流:', userId);
                    this.handleRemoteStream(userId, event.streams[0]);
                };

                // 处理ICE候选
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.socket.emit('ice-candidate', {
                            target: userId,
                            candidate: event.candidate
                        });
                    }
                };

                this.peers.set(userId, peerConnection);

                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    this.socket.emit('offer', {
                        target: userId,
                        offer: offer
                    });
                }
            }

            async handleOffer(data) {
                const peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                // 添加本地音频流
                this.localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, this.localStream);
                });

                // 处理远程音频流
                peerConnection.ontrack = (event) => {
                    console.log('收到远程音频流:', data.caller);
                    this.handleRemoteStream(data.caller, event.streams[0]);
                };

                // 处理ICE候选
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.socket.emit('ice-candidate', {
                            target: data.caller,
                            candidate: event.candidate
                        });
                    }
                };

                this.peers.set(data.caller, peerConnection);

                await peerConnection.setRemoteDescription(data.offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                this.socket.emit('answer', {
                    target: data.caller,
                    answer: answer
                });
            }

            async handleAnswer(data) {
                const peerConnection = this.peers.get(data.answerer);
                if (peerConnection) {
                    await peerConnection.setRemoteDescription(data.answer);
                }
            }

            async handleIceCandidate(data) {
                const peerConnection = this.peers.get(data.sender);
                if (peerConnection) {
                    await peerConnection.addIceCandidate(data.candidate);
                }
            }

            handleRemoteStream(userId, stream) {
                console.log('处理远程音频流:', userId);
                
                // 创建音频元素播放远程音频
                let audioElement = document.getElementById(`audio-${userId}`);
                if (!audioElement) {
                    audioElement = document.createElement('audio');
                    audioElement.id = `audio-${userId}`;
                    audioElement.autoplay = true;
                    audioElement.controls = false;
                    audioElement.volume = 1.0;
                    document.body.appendChild(audioElement);
                }
                
                audioElement.srcObject = stream;
                
                // 确保音频播放
                audioElement.play().then(() => {
                    console.log(`${userId} 的音频开始播放`);
                    this.updateStatus(`${userId} 的音频已连接`, 'success');
                }).catch(error => {
                    console.error('音频播放失败:', error);
                    // 用户交互后重试播放
                    const playAudio = () => {
                        audioElement.play().then(() => {
                            console.log(`${userId} 的音频重试播放成功`);
                            document.removeEventListener('click', playAudio);
                        }).catch(e => console.error('重试播放失败:', e));
                    };
                    document.addEventListener('click', playAudio, { once: true });
                });
                
                // 添加音频活动检测
                this.addAudioLevelDetection(userId, stream);
            }

            addAudioLevelDetection(userId, stream) {
                const audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);

                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                const checkAudioLevel = () => {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    
                    const indicator = document.querySelector(`[data-user="${userId}"] .audio-indicator`);
                    if (indicator) {
                        if (average > 10) {
                            indicator.classList.add('active');
                        } else {
                            indicator.classList.remove('active');
                        }
                    }
                    
                    requestAnimationFrame(checkAudioLevel);
                };
                
                checkAudioLevel();
            }

            removePeer(userId) {
                const peerConnection = this.peers.get(userId);
                if (peerConnection) {
                    peerConnection.close();
                    this.peers.delete(userId);
                }
                
                // 移除音频元素
                const audioElement = document.getElementById(`audio-${userId}`);
                if (audioElement) {
                    audioElement.remove();
                }
                
                // 更新用户列表
                const userCard = document.querySelector(`[data-user="${userId}"]`);
                if (userCard) {
                    userCard.remove();
                }
            }

            updateUsersList(users) {
                this.usersList.innerHTML = '';
                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    if (this.callParticipants.has(user)) {
                        userCard.classList.add('in-call');
                    }
                    userCard.setAttribute('data-user', user);
                    
                    const isCurrentUser = user === this.userName;
                    const statusText = isCurrentUser ? '(您)' : 
                                     this.callParticipants.has(user) ? '通话中' : '在线';
                    
                    userCard.innerHTML = `
                        <div class="audio-indicator"></div>
                        <div class="user-name">${user}</div>
                        <div class="user-status">${statusText}</div>
                        ${!isCurrentUser && !this.inCall ? 
                            `<button class="call-button" onclick="voiceChat.inviteUser('${user}')">📞 邀请通话</button>` : 
                            ''}
                    `;
                    this.usersList.appendChild(userCard);
                });
            }

            // 邀请用户通话
            inviteUser(userId) {
                if (this.inCall) {
                    this.updateStatus('已在通话中', 'error');
                    return;
                }
                
                console.log('邀请用户通话:', userId);
                this.updateStatus(`正在邀请 ${userId} 通话...`, '');
                this.socket.emit('call-invite', { target: userId });
            }

            // 显示通话邀请弹窗
            showCallInvite(callerName) {
                this.currentCaller = callerName;
                this.inviteMessage.textContent = `${callerName} 邀请您加入通话`;
                this.callInviteModal.classList.remove('hidden');
                
                // 播放提示音
                this.playNotificationSound();
            }

            // 接受通话
            acceptCall() {
                if (this.currentCaller) {
                    console.log('接受通话:', this.currentCaller);
                    this.socket.emit('call-response', {
                        caller: this.currentCaller,
                        accepted: true
                    });
                    
                    this.callInviteModal.classList.add('hidden');
                    this.updateStatus(`正在连接 ${this.currentCaller}...`, 'success');
                    
                    // 开始建立连接
                    this.startCall(this.currentCaller);
                }
            }

            // 拒绝通话
            rejectCall() {
                if (this.currentCaller) {
                    console.log('拒绝通话:', this.currentCaller);
                    this.socket.emit('call-response', {
                        caller: this.currentCaller,
                        accepted: false
                    });
                    
                    this.callInviteModal.classList.add('hidden');
                    this.currentCaller = null;
                }
            }

            // 开始通话
            async startCall(targetUser) {
                this.inCall = true;
                this.callParticipants.add(this.userName);
                this.callParticipants.add(targetUser);
                this.updateCallStatus();
                
                // 创建P2P连接
                await this.createPeerConnection(targetUser, true);
            }

            // 结束通话
            endCall() {
                console.log('结束通话');
                
                // 关闭所有连接
                this.peers.forEach(peerConnection => {
                    peerConnection.close();
                });
                this.peers.clear();
                
                // 移除所有远程音频
                document.querySelectorAll('audio[id^="audio-"]').forEach(audio => {
                    audio.remove();
                });
                
                this.inCall = false;
                this.callParticipants.clear();
                this.updateCallStatus();
                this.updateUsersList(Array.from(this.getUsersInRoom()));
                
                this.updateStatus('通话已结束', '');
            }

            // 更新通话状态显示
            updateCallStatus() {
                if (this.inCall) {
                    this.callStatusText.textContent = `通话中 (${this.callParticipants.size} 人)`;
                    this.endCallBtn.classList.remove('hidden');
                } else {
                    this.callStatusText.textContent = '已进入房间，点击用户头像发起通话';
                    this.endCallBtn.classList.add('hidden');
                }
            }

            // 播放通知音
            playNotificationSound() {
                try {
                    // 创建音频上下文播放提示音
                    const audioContext = new AudioContext();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    
                    // 重复播放3次
                    setTimeout(() => {
                        const oscillator2 = audioContext.createOscillator();
                        const gainNode2 = audioContext.createGain();
                        oscillator2.connect(gainNode2);
                        gainNode2.connect(audioContext.destination);
                        oscillator2.frequency.setValueAtTime(800, audioContext.currentTime);
                        gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                        oscillator2.start();
                        oscillator2.stop(audioContext.currentTime + 0.3);
                    }, 500);
                    
                    setTimeout(() => {
                        const oscillator3 = audioContext.createOscillator();
                        const gainNode3 = audioContext.createGain();
                        oscillator3.connect(gainNode3);
                        gainNode3.connect(audioContext.destination);
                        oscillator3.frequency.setValueAtTime(800, audioContext.currentTime);
                        gainNode3.gain.setValueAtTime(0.3, audioContext.currentTime);
                        oscillator3.start();
                        oscillator3.stop(audioContext.currentTime + 0.3);
                    }, 1000);
                } catch (error) {
                    console.error('播放提示音失败:', error);
                }
            }

            // 获取房间内用户列表
            getUsersInRoom() {
                const userCards = document.querySelectorAll('.user-card');
                const users = new Set();
                userCards.forEach(card => {
                    const userName = card.getAttribute('data-user');
                    if (userName) users.add(userName);
                });
                return users;
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                
                if (this.localStream) {
                    this.localStream.getAudioTracks().forEach(track => {
                        track.enabled = !this.isMuted;
                    });
                }
                
                this.muteBtn.textContent = this.isMuted ? '🔊 取消静音' : '🔇 静音';
                this.muteBtn.classList.toggle('muted', this.isMuted);
                
                this.updateStatus(this.isMuted ? '已静音' : '已取消静音', '');
            }

            leaveRoom() {
                console.log('离开房间');
                
                // 关闭所有peer连接
                this.peers.forEach(peerConnection => {
                    peerConnection.close();
                });
                this.peers.clear();
                
                // 停止本地流
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    this.localStream = null;
                }
                
                // 断开socket连接
                if (this.socket) {
                    this.socket.disconnect();
                    this.socket = null;
                }
                
                // 移除所有音频元素
                document.querySelectorAll('audio[id^="audio-"]').forEach(audio => {
                    audio.remove();
                });
                
                // 隐藏通话邀请弹窗
                this.callInviteModal.classList.add('hidden');
                
                // 重置所有状态
                this.inCall = false;
                this.callParticipants.clear();
                this.currentCaller = null;
                this.isMuted = false;
                
                // 重置UI
                this.callSection.classList.add('hidden');
                this.joinBtn.disabled = false;
                this.muteBtn.textContent = '🔇 静音';
                this.muteBtn.classList.remove('muted');
                this.endCallBtn.classList.add('hidden');
                this.usersList.innerHTML = '';
                
                this.updateStatus('已离开房间', '');
            }
        }

        // 初始化应用
        const voiceChat = new VoiceChat();
    </script>
</body>
</html>
