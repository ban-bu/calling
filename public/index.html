<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šäººè¯­éŸ³é€šè¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 800px;
            width: 90%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .room-section {
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #5a6fd8;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mute-btn {
            background: #e74c3c;
        }

        .mute-btn:hover {
            background: #c0392b;
        }

        .mute-btn.muted {
            background: #95a5a6;
        }

        .users-section {
            margin-bottom: 20px;
        }

        .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .user-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-width: 200px;
            text-align: center;
        }

        .user-card.speaking {
            border-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
        }

        .user-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .user-status {
            font-size: 12px;
            color: #666;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .error {
            color: #e74c3c;
            background: #fdf2f2;
            border: 1px solid #e74c3c;
        }

        .success {
            color: #27ae60;
            background: #f2fdf5;
            border: 1px solid #27ae60;
        }

        .audio-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #95a5a6;
            margin: 0 auto 10px;
            transition: background 0.3s;
        }

        .audio-indicator.active {
            background: #27ae60;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .call-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .call-status h3 {
            color: #333;
            margin: 0;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .modal-content p {
            margin-bottom: 25px;
            color: #666;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .accept-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .accept-btn:hover {
            background: #229954;
        }

        .reject-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .reject-btn:hover {
            background: #c0392b;
        }

        .user-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .user-card.in-call {
            border-color: #27ae60;
            background: #f8fff9;
        }

        .call-button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .call-button:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ™ï¸ å¤šäººè¯­éŸ³é€šè¯</h1>
            <p>æ”¯æŒå¤šäººå®æ—¶è¯­éŸ³é€šè¯</p>
        </div>

        <div class="room-section">
            <div class="input-group">
                <input type="text" id="roomId" placeholder="è¾“å…¥æˆ¿é—´å·" value="">
                <input type="text" id="userName" placeholder="è¾“å…¥æ‚¨çš„æ˜µç§°" value="">
                <button id="joinBtn">åŠ å…¥æˆ¿é—´</button>
            </div>
        </div>

        <div id="callSection" class="hidden">
            <div class="call-status">
                <h3 id="callStatusText">å·²è¿›å…¥æˆ¿é—´ï¼Œç‚¹å‡»ç”¨æˆ·å¤´åƒå‘èµ·é€šè¯</h3>
            </div>

            <div class="controls">
                <button id="muteBtn" class="mute-btn">ğŸ”‡ é™éŸ³</button>
                <button id="endCallBtn" class="hidden">ğŸ“ ç»“æŸé€šè¯</button>
                <button id="leaveBtn">ğŸšª ç¦»å¼€æˆ¿é—´</button>
            </div>

            <div class="users-section">
                <h3>æˆ¿é—´æˆå‘˜</h3>
                <div id="usersList" class="users-list"></div>
            </div>
        </div>

        <!-- é€šè¯é‚€è¯·å¼¹çª— -->
        <div id="callInviteModal" class="modal hidden">
            <div class="modal-content">
                <h3>ğŸ“ æ”¶åˆ°é€šè¯é‚€è¯·</h3>
                <p id="inviteMessage"></p>
                <div class="modal-buttons">
                    <button id="acceptCallBtn" class="accept-btn">âœ… æ¥å¬</button>
                    <button id="rejectCallBtn" class="reject-btn">âŒ æ‹’ç»</button>
                </div>
            </div>
        </div>

        <div id="status" class="status">
            è¯·è¾“å…¥æˆ¿é—´å·å’Œæ˜µç§°åŠ å…¥é€šè¯
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        class VoiceChat {
            constructor() {
                this.socket = null;
                this.localStream = null;
                this.peers = new Map();
                this.roomId = null;
                this.userName = null;
                this.isMuted = false;
                this.inCall = false;
                this.callParticipants = new Set();
                this.currentCaller = null;
                
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.roomIdInput = document.getElementById('roomId');
                this.userNameInput = document.getElementById('userName');
                this.joinBtn = document.getElementById('joinBtn');
                this.muteBtn = document.getElementById('muteBtn');
                this.endCallBtn = document.getElementById('endCallBtn');
                this.leaveBtn = document.getElementById('leaveBtn');
                this.callSection = document.getElementById('callSection');
                this.usersList = document.getElementById('usersList');
                this.status = document.getElementById('status');
                this.callStatusText = document.getElementById('callStatusText');
                this.callInviteModal = document.getElementById('callInviteModal');
                this.inviteMessage = document.getElementById('inviteMessage');
                this.acceptCallBtn = document.getElementById('acceptCallBtn');
                this.rejectCallBtn = document.getElementById('rejectCallBtn');
                
                // ç”Ÿæˆéšæœºæˆ¿é—´å·
                this.roomIdInput.value = Math.random().toString(36).substring(7);
            }

            bindEvents() {
                this.joinBtn.addEventListener('click', () => this.joinRoom());
                this.muteBtn.addEventListener('click', () => this.toggleMute());
                this.endCallBtn.addEventListener('click', () => this.endCall());
                this.leaveBtn.addEventListener('click', () => this.leaveRoom());
                this.acceptCallBtn.addEventListener('click', () => this.acceptCall());
                this.rejectCallBtn.addEventListener('click', () => this.rejectCall());
            }

            updateStatus(message, type = '') {
                this.status.textContent = message;
                this.status.className = 'status ' + type;
            }

            async joinRoom() {
                this.roomId = this.roomIdInput.value.trim();
                this.userName = this.userNameInput.value.trim();

                if (!this.roomId || !this.userName) {
                    this.updateStatus('è¯·è¾“å…¥æˆ¿é—´å·å’Œæ˜µç§°', 'error');
                    return;
                }

                try {
                    this.updateStatus('æ­£åœ¨è·å–éº¦å…‹é£æƒé™...', '');
                    
                    // è·å–éŸ³é¢‘æµ
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });

                    this.updateStatus('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...', '');
                    
                    // è¿æ¥Socket.IO
                    this.socket = io();
                    this.bindSocketEvents();
                    
                    // åŠ å…¥æˆ¿é—´
                    this.socket.emit('join-room', this.roomId, this.userName);
                    
                    this.callSection.classList.remove('hidden');
                    this.joinBtn.disabled = true;
                    this.updateStatus(`å·²åŠ å…¥æˆ¿é—´: ${this.roomId}`, 'success');
                    
                } catch (error) {
                    console.error('åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
                    this.updateStatus('æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®', 'error');
                }
            }

            bindSocketEvents() {
                this.socket.on('user-joined', (userId) => {
                    console.log('ç”¨æˆ·åŠ å…¥:', userId);
                    this.updateStatus(`${userId} åŠ å…¥äº†æˆ¿é—´`, 'success');
                    // ä¸ç«‹å³åˆ›å»ºè¿æ¥ï¼Œç­‰å¾…é€šè¯é‚€è¯·
                });

                this.socket.on('user-left', (userId) => {
                    console.log('ç”¨æˆ·ç¦»å¼€:', userId);
                    this.updateStatus(`${userId} ç¦»å¼€äº†æˆ¿é—´`, '');
                    this.removePeer(userId);
                    this.callParticipants.delete(userId);
                    this.updateCallStatus();
                });

                this.socket.on('room-users', (users) => {
                    console.log('æˆ¿é—´ç”¨æˆ·:', users);
                    this.updateUsersList(users);
                });

                // é€šè¯é‚€è¯·ç›¸å…³äº‹ä»¶
                this.socket.on('call-invite', (data) => {
                    console.log('æ”¶åˆ°é€šè¯é‚€è¯·:', data.caller);
                    this.showCallInvite(data.caller);
                });

                this.socket.on('call-response', (data) => {
                    console.log('é€šè¯å“åº”:', data);
                    if (data.accepted) {
                        this.updateStatus(`${data.responder} æ¥å—äº†é€šè¯`, 'success');
                        this.startCall(data.responder);
                    } else {
                        this.updateStatus(`${data.responder} æ‹’ç»äº†é€šè¯`, '');
                    }
                });

                this.socket.on('call-started', (data) => {
                    console.log('é€šè¯å¼€å§‹:', data.participants);
                    this.callParticipants = new Set(data.participants);
                    this.inCall = true;
                    this.updateCallStatus();
                });

                this.socket.on('offer', async (data) => {
                    console.log('æ”¶åˆ°offer:', data.caller);
                    await this.handleOffer(data);
                });

                this.socket.on('answer', async (data) => {
                    console.log('æ”¶åˆ°answer:', data.answerer);
                    await this.handleAnswer(data);
                });

                this.socket.on('ice-candidate', async (data) => {
                    console.log('æ”¶åˆ°ICE candidate:', data.sender);
                    await this.handleIceCandidate(data);
                });
            }

            async createPeerConnection(userId, isInitiator) {
                const peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                // æ·»åŠ æœ¬åœ°éŸ³é¢‘æµ
                this.localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, this.localStream);
                });

                // å¤„ç†è¿œç¨‹éŸ³é¢‘æµ
                peerConnection.ontrack = (event) => {
                    console.log('æ”¶åˆ°è¿œç¨‹éŸ³é¢‘æµ:', userId);
                    this.handleRemoteStream(userId, event.streams[0]);
                };

                // å¤„ç†ICEå€™é€‰
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.socket.emit('ice-candidate', {
                            target: userId,
                            candidate: event.candidate
                        });
                    }
                };

                this.peers.set(userId, peerConnection);

                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    this.socket.emit('offer', {
                        target: userId,
                        offer: offer
                    });
                }
            }

            async handleOffer(data) {
                const peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                // æ·»åŠ æœ¬åœ°éŸ³é¢‘æµ
                this.localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, this.localStream);
                });

                // å¤„ç†è¿œç¨‹éŸ³é¢‘æµ
                peerConnection.ontrack = (event) => {
                    console.log('æ”¶åˆ°è¿œç¨‹éŸ³é¢‘æµ:', data.caller);
                    this.handleRemoteStream(data.caller, event.streams[0]);
                };

                // å¤„ç†ICEå€™é€‰
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.socket.emit('ice-candidate', {
                            target: data.caller,
                            candidate: event.candidate
                        });
                    }
                };

                this.peers.set(data.caller, peerConnection);

                await peerConnection.setRemoteDescription(data.offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                this.socket.emit('answer', {
                    target: data.caller,
                    answer: answer
                });
            }

            async handleAnswer(data) {
                const peerConnection = this.peers.get(data.answerer);
                if (peerConnection) {
                    await peerConnection.setRemoteDescription(data.answer);
                }
            }

            async handleIceCandidate(data) {
                const peerConnection = this.peers.get(data.sender);
                if (peerConnection) {
                    await peerConnection.addIceCandidate(data.candidate);
                }
            }

            handleRemoteStream(userId, stream) {
                console.log('å¤„ç†è¿œç¨‹éŸ³é¢‘æµ:', userId);
                
                // åˆ›å»ºéŸ³é¢‘å…ƒç´ æ’­æ”¾è¿œç¨‹éŸ³é¢‘
                let audioElement = document.getElementById(`audio-${userId}`);
                if (!audioElement) {
                    audioElement = document.createElement('audio');
                    audioElement.id = `audio-${userId}`;
                    audioElement.autoplay = true;
                    audioElement.controls = false;
                    audioElement.volume = 1.0;
                    document.body.appendChild(audioElement);
                }
                
                audioElement.srcObject = stream;
                
                // ç¡®ä¿éŸ³é¢‘æ’­æ”¾
                audioElement.play().then(() => {
                    console.log(`${userId} çš„éŸ³é¢‘å¼€å§‹æ’­æ”¾`);
                    this.updateStatus(`${userId} çš„éŸ³é¢‘å·²è¿æ¥`, 'success');
                }).catch(error => {
                    console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                    // ç”¨æˆ·äº¤äº’åé‡è¯•æ’­æ”¾
                    const playAudio = () => {
                        audioElement.play().then(() => {
                            console.log(`${userId} çš„éŸ³é¢‘é‡è¯•æ’­æ”¾æˆåŠŸ`);
                            document.removeEventListener('click', playAudio);
                        }).catch(e => console.error('é‡è¯•æ’­æ”¾å¤±è´¥:', e));
                    };
                    document.addEventListener('click', playAudio, { once: true });
                });
                
                // æ·»åŠ éŸ³é¢‘æ´»åŠ¨æ£€æµ‹
                this.addAudioLevelDetection(userId, stream);
            }

            addAudioLevelDetection(userId, stream) {
                const audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);

                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                const checkAudioLevel = () => {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    
                    const indicator = document.querySelector(`[data-user="${userId}"] .audio-indicator`);
                    if (indicator) {
                        if (average > 10) {
                            indicator.classList.add('active');
                        } else {
                            indicator.classList.remove('active');
                        }
                    }
                    
                    requestAnimationFrame(checkAudioLevel);
                };
                
                checkAudioLevel();
            }

            removePeer(userId) {
                const peerConnection = this.peers.get(userId);
                if (peerConnection) {
                    peerConnection.close();
                    this.peers.delete(userId);
                }
                
                // ç§»é™¤éŸ³é¢‘å…ƒç´ 
                const audioElement = document.getElementById(`audio-${userId}`);
                if (audioElement) {
                    audioElement.remove();
                }
                
                // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
                const userCard = document.querySelector(`[data-user="${userId}"]`);
                if (userCard) {
                    userCard.remove();
                }
            }

            updateUsersList(users) {
                this.usersList.innerHTML = '';
                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    if (this.callParticipants.has(user)) {
                        userCard.classList.add('in-call');
                    }
                    userCard.setAttribute('data-user', user);
                    
                    const isCurrentUser = user === this.userName;
                    const statusText = isCurrentUser ? '(æ‚¨)' : 
                                     this.callParticipants.has(user) ? 'é€šè¯ä¸­' : 'åœ¨çº¿';
                    
                    userCard.innerHTML = `
                        <div class="audio-indicator"></div>
                        <div class="user-name">${user}</div>
                        <div class="user-status">${statusText}</div>
                        ${!isCurrentUser && !this.inCall ? 
                            `<button class="call-button" onclick="voiceChat.inviteUser('${user}')">ğŸ“ é‚€è¯·é€šè¯</button>` : 
                            ''}
                    `;
                    this.usersList.appendChild(userCard);
                });
            }

            // é‚€è¯·ç”¨æˆ·é€šè¯
            inviteUser(userId) {
                if (this.inCall) {
                    this.updateStatus('å·²åœ¨é€šè¯ä¸­', 'error');
                    return;
                }
                
                console.log('é‚€è¯·ç”¨æˆ·é€šè¯:', userId);
                this.updateStatus(`æ­£åœ¨é‚€è¯· ${userId} é€šè¯...`, '');
                this.socket.emit('call-invite', { target: userId });
            }

            // æ˜¾ç¤ºé€šè¯é‚€è¯·å¼¹çª—
            showCallInvite(callerName) {
                this.currentCaller = callerName;
                this.inviteMessage.textContent = `${callerName} é‚€è¯·æ‚¨åŠ å…¥é€šè¯`;
                this.callInviteModal.classList.remove('hidden');
                
                // æ’­æ”¾æç¤ºéŸ³
                this.playNotificationSound();
            }

            // æ¥å—é€šè¯
            acceptCall() {
                if (this.currentCaller) {
                    console.log('æ¥å—é€šè¯:', this.currentCaller);
                    this.socket.emit('call-response', {
                        caller: this.currentCaller,
                        accepted: true
                    });
                    
                    this.callInviteModal.classList.add('hidden');
                    this.updateStatus(`æ­£åœ¨è¿æ¥ ${this.currentCaller}...`, 'success');
                    
                    // å¼€å§‹å»ºç«‹è¿æ¥
                    this.startCall(this.currentCaller);
                }
            }

            // æ‹’ç»é€šè¯
            rejectCall() {
                if (this.currentCaller) {
                    console.log('æ‹’ç»é€šè¯:', this.currentCaller);
                    this.socket.emit('call-response', {
                        caller: this.currentCaller,
                        accepted: false
                    });
                    
                    this.callInviteModal.classList.add('hidden');
                    this.currentCaller = null;
                }
            }

            // å¼€å§‹é€šè¯
            async startCall(targetUser) {
                this.inCall = true;
                this.callParticipants.add(this.userName);
                this.callParticipants.add(targetUser);
                this.updateCallStatus();
                
                // åˆ›å»ºP2Pè¿æ¥
                await this.createPeerConnection(targetUser, true);
            }

            // ç»“æŸé€šè¯
            endCall() {
                console.log('ç»“æŸé€šè¯');
                
                // å…³é—­æ‰€æœ‰è¿æ¥
                this.peers.forEach(peerConnection => {
                    peerConnection.close();
                });
                this.peers.clear();
                
                // ç§»é™¤æ‰€æœ‰è¿œç¨‹éŸ³é¢‘
                document.querySelectorAll('audio[id^="audio-"]').forEach(audio => {
                    audio.remove();
                });
                
                this.inCall = false;
                this.callParticipants.clear();
                this.updateCallStatus();
                this.updateUsersList(Array.from(this.getUsersInRoom()));
                
                this.updateStatus('é€šè¯å·²ç»“æŸ', '');
            }

            // æ›´æ–°é€šè¯çŠ¶æ€æ˜¾ç¤º
            updateCallStatus() {
                if (this.inCall) {
                    this.callStatusText.textContent = `é€šè¯ä¸­ (${this.callParticipants.size} äºº)`;
                    this.endCallBtn.classList.remove('hidden');
                } else {
                    this.callStatusText.textContent = 'å·²è¿›å…¥æˆ¿é—´ï¼Œç‚¹å‡»ç”¨æˆ·å¤´åƒå‘èµ·é€šè¯';
                    this.endCallBtn.classList.add('hidden');
                }
            }

            // æ’­æ”¾é€šçŸ¥éŸ³
            playNotificationSound() {
                try {
                    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡æ’­æ”¾æç¤ºéŸ³
                    const audioContext = new AudioContext();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    
                    // é‡å¤æ’­æ”¾3æ¬¡
                    setTimeout(() => {
                        const oscillator2 = audioContext.createOscillator();
                        const gainNode2 = audioContext.createGain();
                        oscillator2.connect(gainNode2);
                        gainNode2.connect(audioContext.destination);
                        oscillator2.frequency.setValueAtTime(800, audioContext.currentTime);
                        gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                        oscillator2.start();
                        oscillator2.stop(audioContext.currentTime + 0.3);
                    }, 500);
                    
                    setTimeout(() => {
                        const oscillator3 = audioContext.createOscillator();
                        const gainNode3 = audioContext.createGain();
                        oscillator3.connect(gainNode3);
                        gainNode3.connect(audioContext.destination);
                        oscillator3.frequency.setValueAtTime(800, audioContext.currentTime);
                        gainNode3.gain.setValueAtTime(0.3, audioContext.currentTime);
                        oscillator3.start();
                        oscillator3.stop(audioContext.currentTime + 0.3);
                    }, 1000);
                } catch (error) {
                    console.error('æ’­æ”¾æç¤ºéŸ³å¤±è´¥:', error);
                }
            }

            // è·å–æˆ¿é—´å†…ç”¨æˆ·åˆ—è¡¨
            getUsersInRoom() {
                const userCards = document.querySelectorAll('.user-card');
                const users = new Set();
                userCards.forEach(card => {
                    const userName = card.getAttribute('data-user');
                    if (userName) users.add(userName);
                });
                return users;
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                
                if (this.localStream) {
                    this.localStream.getAudioTracks().forEach(track => {
                        track.enabled = !this.isMuted;
                    });
                }
                
                this.muteBtn.textContent = this.isMuted ? 'ğŸ”Š å–æ¶ˆé™éŸ³' : 'ğŸ”‡ é™éŸ³';
                this.muteBtn.classList.toggle('muted', this.isMuted);
                
                this.updateStatus(this.isMuted ? 'å·²é™éŸ³' : 'å·²å–æ¶ˆé™éŸ³', '');
            }

            leaveRoom() {
                console.log('ç¦»å¼€æˆ¿é—´');
                
                // å…³é—­æ‰€æœ‰peerè¿æ¥
                this.peers.forEach(peerConnection => {
                    peerConnection.close();
                });
                this.peers.clear();
                
                // åœæ­¢æœ¬åœ°æµ
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    this.localStream = null;
                }
                
                // æ–­å¼€socketè¿æ¥
                if (this.socket) {
                    this.socket.disconnect();
                    this.socket = null;
                }
                
                // ç§»é™¤æ‰€æœ‰éŸ³é¢‘å…ƒç´ 
                document.querySelectorAll('audio[id^="audio-"]').forEach(audio => {
                    audio.remove();
                });
                
                // éšè—é€šè¯é‚€è¯·å¼¹çª—
                this.callInviteModal.classList.add('hidden');
                
                // é‡ç½®æ‰€æœ‰çŠ¶æ€
                this.inCall = false;
                this.callParticipants.clear();
                this.currentCaller = null;
                this.isMuted = false;
                
                // é‡ç½®UI
                this.callSection.classList.add('hidden');
                this.joinBtn.disabled = false;
                this.muteBtn.textContent = 'ğŸ”‡ é™éŸ³';
                this.muteBtn.classList.remove('muted');
                this.endCallBtn.classList.add('hidden');
                this.usersList.innerHTML = '';
                
                this.updateStatus('å·²ç¦»å¼€æˆ¿é—´', '');
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        const voiceChat = new VoiceChat();
    </script>
</body>
</html>
